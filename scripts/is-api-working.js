import process from 'process';
import fetch from 'node-fetch';

const green = (str) => `\x1b[32m${str}\x1b[0m`;
const red = (str) => `\x1b[31m${str}\x1b[0m`;
const yellow = (str) => `\x1b[33m${str}\x1b[0m`;

const renderLines = (function () {
  let cleanUp = [];
  return (lines) => {
    cleanUp.forEach((clr) => process.stdout.write(clr));
    cleanUp = [];

    for (const line of lines) {
      process.stdout.write(line[0] + ': ' + line[1] + '\n');
      cleanUp.push('\u001b[1A' + '\u001b[2K' + '\u001b[1G');
      // \u001b[2K = clear line
      // \u001b[1A = clear line and return
      // \u001b[1G = reset cursor to start of line
    }
  };
})();

async function measurePromiseTime(promise) {
  const result = {};
  const start = Date.now();
  let stop = NaN;
  try {
    await promise;
  } catch (e) {
    result.error = e.message;
  } finally {
    stop = Date.now();
  }

  result.time = stop - start;
  return result;
}

async function runTests() {
  let report = new Map();
  const render = (r) => renderLines(r.entries());

  function createTest(testName, testFn) {
    report.set(testName, '...testing...');
    measurePromiseTime(testFn).then(({ time, error }) => {
      if (error) {
        report.set(testName, red(`Fail (${error})`));
      } else {
        report.set(
          testName,
          (time < 30000 ? green : yellow)(
            `Ok (${time > 10000 ? time / 1000 + ' sec' : time + ' ms'})`,
          ),
        );
      }

      render(report);
    });
  }

  /* Add you tests here */
  const api = {
    sonic: 'https://test-apps-ninja01.konturlabs.com/active/api',
    zigzag: 'https://test-apps-ninja02.konturlabs.com/active/api',
  };

  createTest('/layers on sonic', testLayersApi(api.sonic));
  createTest('/layers on zigzag', testLayersApi(api.zigzag));
  createTest('/events on sonic', testEventsApi(api.sonic));
  createTest('/events on zigzag', testEventsApi(api.zigzag));
  createTest('/analytics on sonic', testAnalyticsApi(api.sonic));
  createTest('/analytics on zigzag', testAnalyticsApi(api.zigzag));
  render(report);
}

function testLayersApi(url) {
  return fetch(url + '/layers/search', {
    credentials: 'include',
    headers: {
      'User-Agent':
        'Mozilla/5.0 (X11; Fedora; Linux x86_64; rv:95.0) Gecko/20100101 Firefox/95.0',
      Accept: 'application/json',
      'Accept-Language': 'en-US,en;q=0.5',
      'Content-Type': 'application/json',
      'Sec-Fetch-Dest': 'empty',
      'Sec-Fetch-Mode': 'cors',
      'Sec-Fetch-Site': 'same-origin',
      Pragma: 'no-cache',
      'Cache-Control': 'no-cache',
    },
    referrer:
      'https://test-apps-ninja02.konturlabs.com/active/?map=6.547/112.787/-8.109&event=77d85257-2e53-41fa-a5ec-c48f64be5b63&layers=,focused-geometry',
    body: '{"id":"77d85257-2e53-41fa-a5ec-c48f64be5b63","geoJSON":{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[113.832,-8.108],[113.831,-8.077],[113.83,-8.045],[113.827,-8.014],[113.823,-7.983],[113.818,-7.952],[113.812,-7.921],[113.805,-7.89],[113.797,-7.86],[113.787,-7.83],[113.777,-7.8],[113.766,-7.771],[113.753,-7.742],[113.74,-7.713],[113.725,-7.685],[113.71,-7.658],[113.694,-7.631],[113.676,-7.604],[113.658,-7.578],[113.639,-7.553],[113.619,-7.529],[113.598,-7.505],[113.577,-7.482],[113.554,-7.46],[113.531,-7.439],[113.507,-7.418],[113.482,-7.398],[113.457,-7.379],[113.431,-7.361],[113.404,-7.344],[113.377,-7.328],[113.349,-7.313],[113.321,-7.298],[113.292,-7.285],[113.263,-7.273],[113.233,-7.261],[113.203,-7.251],[113.173,-7.242],[113.142,-7.234],[113.111,-7.227],[113.08,-7.221],[113.049,-7.216],[113.017,-7.212],[112.985,-7.209],[112.954,-7.208],[112.922,-7.207],[112.89,-7.208],[112.859,-7.209],[112.827,-7.212],[112.795,-7.216],[112.764,-7.221],[112.733,-7.227],[112.702,-7.234],[112.671,-7.242],[112.641,-7.251],[112.611,-7.261],[112.581,-7.273],[112.552,-7.285],[112.523,-7.298],[112.495,-7.313],[112.467,-7.328],[112.44,-7.344],[112.413,-7.361],[112.387,-7.379],[112.362,-7.398],[112.337,-7.418],[112.313,-7.439],[112.29,-7.46],[112.267,-7.482],[112.246,-7.505],[112.225,-7.529],[112.205,-7.553],[112.186,-7.578],[112.168,-7.604],[112.15,-7.631],[112.134,-7.658],[112.119,-7.685],[112.104,-7.713],[112.091,-7.742],[112.078,-7.771],[112.067,-7.8],[112.057,-7.83],[112.047,-7.86],[112.039,-7.89],[112.032,-7.921],[112.026,-7.952],[112.021,-7.983],[112.017,-8.014],[112.014,-8.045],[112.013,-8.077],[112.012,-8.108],[112.013,-8.139],[112.014,-8.171],[112.017,-8.202],[112.021,-8.233],[112.026,-8.264],[112.032,-8.295],[112.039,-8.326],[112.047,-8.356],[112.057,-8.386],[112.067,-8.416],[112.078,-8.445],[112.091,-8.474],[112.104,-8.503],[112.119,-8.531],[112.134,-8.558],[112.15,-8.585],[112.168,-8.612],[112.186,-8.638],[112.205,-8.663],[112.225,-8.687],[112.246,-8.711],[112.267,-8.734],[112.29,-8.756],[112.313,-8.777],[112.337,-8.798],[112.362,-8.818],[112.387,-8.837],[112.413,-8.855],[112.44,-8.872],[112.467,-8.888],[112.495,-8.903],[112.523,-8.918],[112.552,-8.931],[112.581,-8.943],[112.611,-8.955],[112.641,-8.965],[112.671,-8.974],[112.702,-8.982],[112.733,-8.989],[112.764,-8.995],[112.795,-9],[112.827,-9.004],[112.859,-9.007],[112.89,-9.008],[112.922,-9.009],[112.954,-9.008],[112.985,-9.007],[113.017,-9.004],[113.049,-9],[113.08,-8.995],[113.111,-8.989],[113.142,-8.982],[113.173,-8.974],[113.203,-8.965],[113.233,-8.955],[113.263,-8.943],[113.292,-8.931],[113.321,-8.918],[113.349,-8.903],[113.377,-8.888],[113.404,-8.872],[113.431,-8.855],[113.457,-8.837],[113.482,-8.818],[113.507,-8.798],[113.531,-8.777],[113.554,-8.756],[113.577,-8.734],[113.598,-8.711],[113.619,-8.687],[113.639,-8.663],[113.658,-8.638],[113.676,-8.612],[113.694,-8.585],[113.71,-8.558],[113.725,-8.531],[113.74,-8.503],[113.753,-8.474],[113.766,-8.445],[113.777,-8.416],[113.787,-8.386],[113.797,-8.356],[113.805,-8.326],[113.812,-8.295],[113.818,-8.264],[113.823,-8.233],[113.827,-8.202],[113.83,-8.171],[113.831,-8.139],[113.832,-8.108],[113.832,-8.108]]]},"properties":{}}]}}',
    method: 'POST',
    mode: 'cors',
  });
}

function testEventsApi(url) {
  return fetch(url + '/events/', {
    credentials: 'include',
    headers: {
      'User-Agent':
        'Mozilla/5.0 (X11; Fedora; Linux x86_64; rv:95.0) Gecko/20100101 Firefox/95.0',
      Accept: 'application/json',
      'Accept-Language': 'en-US,en;q=0.5',
      'Sec-Fetch-Dest': 'empty',
      'Sec-Fetch-Mode': 'cors',
      'Sec-Fetch-Site': 'same-origin',
      Pragma: 'no-cache',
      'Cache-Control': 'no-cache',
    },
    referrer:
      'https://test-apps-ninja01.konturlabs.com/active/?map=6.547/112.787/-8.109&event=77d85257-2e53-41fa-a5ec-c48f64be5b63&layers=,focused-geometry',
    method: 'GET',
    mode: 'cors',
  });
}

function testAnalyticsApi(url) {
  return fetch(url + '/polygon_details', {
    credentials: 'include',
    headers: {
      'User-Agent':
        'Mozilla/5.0 (X11; Fedora; Linux x86_64; rv:95.0) Gecko/20100101 Firefox/95.0',
      Accept: 'application/json',
      'Accept-Language': 'en-US,en;q=0.5',
      'Content-Type': 'application/json',
      'Sec-Fetch-Dest': 'empty',
      'Sec-Fetch-Mode': 'cors',
      'Sec-Fetch-Site': 'same-origin',
      Pragma: 'no-cache',
      'Cache-Control': 'no-cache',
    },
    referrer:
      'http://localhost:3000/?layers=,count%26area_km2%7Cpopulation%26area_km2,activeContributors,eventShape,focused-geometry',
    body: '{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[36.89999999999999,-18.33499999999998],[36.815225661082025,-18.333577581089592],[36.73055460663751,-18.329312057356688],[36.64608999530381,-18.32220862568488],[36.56193473419902,-18.31227594051158],[36.47819135354551,-18.29952610328348],[36.39496188175311,-18.283974647713382],[34.13908042532961,-17.830572050423292],[34.08004118325491,-17.817482975702085],[34.02151359630881,-17.802423247129195],[33.96356897134041,-17.785411212663988],[33.906277904949505,-17.766467598850085],[33.849710197475616,-17.745615485562787],[33.793934767956515,-17.72288027789019],[33.739019570161815,-17.69828967518069],[33.68503150980071,-17.671873637295786],[33.632036363008616,-17.64366434810869],[33.58009869620871,-17.613696176292787],[33.529281787447516,-17.58200563344929],[33.479647549300715,-17.548631329622985],[33.431256453441705,-17.513613926262394],[33.38416745696701,-17.476996086679293],[33.33843793056511,-17.438822424070782],[33.294123588619804,-17.39913944716449],[33.25127842133082,-17.357995503555088],[33.20995462893472,-17.315440720800193],[33.170202558106915,-17.271526945347482],[33.132070640622416,-17.22630767936789],[33.09560533434902,-17.179838015571587],[33.06085106664531,-17.132174570085688],[33.02785018023291,-17.083375413476794],[32.996642881608715,-17.033499999999993],[32.96726719205881,-16.982609095164083],[32.93975890133601,-16.930764701697388],[32.91415152405521,-16.87802998400739],[32.89047625886111,-16.824469191224292],[32.86876195041742,-16.770147578923893],[32.84903505426421,-16.715131329622984],[32.83131960458581,-16.65948747214689],[32.815637184928605,-16.60328379996459],[32.802006901905415,-16.546588788593183],[32.79044536191651,-16.489471512170795],[32.780966650917314,-16.432001559300385],[32.773582317257215,-16.374248948267184],[32.76830135760931,-16.31628404173149],[32.76513020600941,-16.258177461003083],[32.764072726017304,-16.200000000000003],[32.76513020600941,-16.141822538996898],[32.76830135760931,-16.083715958268492],[32.773582317257215,-16.025751051732797],[32.780966650917314,-15.9679984406996],[32.79044536191651,-15.9105284878292],[32.802006901905415,-15.853411211406797],[32.815637184928605,-15.796716200035405],[32.83131960458581,-15.740512527853104],[32.84903505426421,-15.684868670376996],[32.86876195041742,-15.6298524210761],[32.89047625886111,-15.575530808775701],[32.91415152405521,-15.521970015992604],[32.93975890133601,-15.469235298302605],[32.96726719205881,-15.417390904835898],[32.996642881608715,-15.366500000000002],[33.02785018023291,-15.316624586523199],[33.06085106664531,-15.267825429914295],[33.09560533434902,-15.220161984428396],[33.132070640622416,-15.173692320632105],[33.170202558106915,-15.128473054652499],[33.20995462893472,-15.084559279199802],[33.25127842133082,-15.042004496444903],[33.294123588619804,-15.000860552835505],[33.33843793056511,-14.961177575929199],[33.38416745696701,-14.9230039133207],[33.431256453441705,-14.8863860737376],[33.479647549300715,-14.851368670376996],[33.529281787447516,-14.817994366550696],[33.58009869620871,-14.786303823707206],[33.632036363008616,-14.756335651891304],[33.68503150980071,-14.728126362704195],[33.739019570161815,-14.701710324819304],[33.793934767956515,-14.677119722109802],[33.849710197475616,-14.654384514437195],[35.99004343008562,-13.835025699586602],[36.06919914936812,-13.805817730464906],[36.14936707151202,-13.779283034450794],[36.230449524253224,-13.755453939984003],[36.31234772111272,-13.734359479145501],[36.39496188175311,-13.716025352286607],[36.47819135354551,-13.700473896716494],[36.56193473419902,-13.687724059488392],[36.64608999530381,-13.677791374315094],[36.73055460663751,-13.670687942643301],[36.815225661082025,-13.666422418910399],[39.41526793744721,-13.566422418910406],[42.015309913815415,-13.466422418910405],[42.1,-13.465],[44.20000000000001,-13.497999999999998],[44.2725057953137,-13.499219564307806],[44.34492325348451,-13.5028767713798],[44.417164144994594,-13.508967165472702],[44.48914045544571,-13.517483326379402],[44.5607644927904,-13.528414878469606],[44.63194899417219,-13.541748503330906],[44.702607232241206,-13.557467955995504],[44.772653120818504,-13.575554084731499],[44.8420013197785,-13.5959848543771],[44.91056733902299,-13.618735373186603],[44.97826764141951,-13.643777923157295],[45.0450197445778,-13.671081993799502],[45.1107423213427,-13.700614319309096],[45.17535529887811,-13.7323389190964],[45.2387799562238,-13.766217141623605],[45.3009390202047,-13.802207711494805],[45.36175675957599,-13.840266779744798],[45.4211590772908,-13.880347977261405],[45.47907360077501,-13.922402471279302],[45.53542977010281,-13.966379024875803],[45.590158923963,-14.012224059394299],[45.6431943833118,-14.059881719722004],[45.69447153261169,-14.109293942341104],[45.743927898554695,-14.160400526069598],[45.79150322617729,-14.213139205407495],[45.837139552271005,-14.267445726398],[45.8807812760023,-14.323253924910503],[45.92237522665331,-14.380495807251595],[45.961870728402104,-14.439101633005103],[45.999219662063794,-14.498999999999999],[46.03437652371589,-14.560117931302601],[46.06729848013781,-14.622380964128302],[46.0979454209969,-14.685713240562198],[46.1262800077167,-14.7500375999813],[46.15226771896769,-14.815275673061993],[46.1758768927269,-14.881347977261406],[46.19707876485289,-14.948174013654398],[46.21584750413031,-15.015672365009493],[46.232160243741404,-15.083760794982801],[46.2459971091258,-15.152356348310796],[46.2573412421945,-15.221375451877906],[46.26617882186859,-15.290734016538195],[46.2724990809187,-15.360347539564296],[46.2762943190828,-15.430131207601606],[46.27755991244769,-15.499999999999998],[46.2762943190828,-15.56986879239839],[46.2724990809187,-15.639652460435686],[46.26617882186859,-15.709265983461787],[46.2573412421945,-15.77862454812209],[46.2459971091258,-15.847643651689186],[46.232160243741404,-15.916239205017181],[46.21584750413031,-15.984327634990489],[46.19707876485289,-16.051825986345584],[46.1758768927269,-16.11865202273859],[46.15226771896769,-16.18472432693799],[46.1262800077167,-16.24996240001868],[46.0979454209969,-16.314286759437785],[46.06729848013781,-16.37761903587168],[46.03437652371589,-16.43988206869738],[45.999219662063794,-16.500999999999983],[45.961870728402104,-16.56089836699488],[45.92237522665331,-16.619504192748387],[45.8807812760023,-16.67674607508948],[45.837139552271005,-16.73255427360198],[45.79150322617729,-16.786860794592485],[45.743927898554695,-16.839599473930384],[45.69447153261169,-16.89070605765888],[45.6431943833118,-16.94011828027798],[45.590158923963,-16.987775940605683],[45.53542977010281,-17.033620975124194],[45.47907360077501,-17.07759752872068],[45.4211590772908,-17.11965202273859],[45.36175675957599,-17.159733220255184],[45.3009390202047,-17.19779228850519],[45.2387799562238,-17.233782858376394],[45.17535529887811,-17.267661080903583],[45.1107423213427,-17.299385680690886],[45.0450197445778,-17.32891800620048],[44.97826764141951,-17.356222076842688],[44.91056733902299,-17.38126462681338],[44.8420013197785,-17.404015145622882],[42.84988691410659,-18.020716965549184],[42.76888504492829,-18.044546060015975],[42.6870682423567,-18.065640520854476],[42.6045361875627,-18.08397464771339],[42.52138943314189,-18.099526103283484],[42.43772928060701,-18.112275940511587],[42.3536576569668,-18.122208625684884],[42.269276990544604,-18.129312057356678],[42.1846900861846,-18.13357758108958],[39.5847320625528,-18.233577581089577],[36.984774338917994,-18.333577581089592],[36.89999999999999,-18.33499999999998]]]},"properties":{}}]}',
    method: 'POST',
    mode: 'cors',
  });
}

runTests();
setInterval(() => {
  runTests();
}, 120000);
